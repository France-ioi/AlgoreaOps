version: 2.1

parameters:
  deploy-app:
    type: enum
    enum: ["auto", "frontend", "backend"]
    default: auto
  deploy-env:
    type: string
    default: ""
  deploy-version:
    type: string
    default: ""
  deploy-app-config:
    type: string
    default: ""
  aws-account:
    type: enum
    enum: [ "dev", "prod" ]
    default: dev
  slack-channel:
    type: string
    default: ""

orbs:
  aws-cli: circleci/aws-cli@4.1.2
  slack: circleci/slack@4.9.3

jobs:
  frontend-deploy:
    working_directory: /home/circleci/project
    docker:
      - image: cimg/node:18.13
    steps:
      - checkout
      - aws-cli/setup
      - run: npm install -g serverless@3.30.1 serverless-prune-plugin@2.0.2
      - run: ./scripts/get-config.sh ./config frontend << pipeline.parameters.deploy-env >> << pipeline.parameters.deploy-app-config >>
      - run: ./scripts/decrypt.sh ./config
      - run: ./scripts/frontend-deploy.sh << pipeline.parameters.deploy-env >> << pipeline.parameters.deploy-version >> ./config
      - slack/notify:
          channel: << pipeline.parameters.slack-channel >>
          event: pass
          custom: |
              {
                "blocks": [
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "plain_text",
                        "text": "${OUTPUTMSG}",
                        "emoji": true
                      }
                    ],
                    "accessory": {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Release now ðŸš€",
                        "emoji": true
                      },
                      "value": "release frontend << pipeline.parameters.deploy-env >> ${DEPLOYED_VERSION}",
                      "action_id": "command"
                    }
                  }
                ]
              }
      - slack/notify:
          channel: << pipeline.parameters.slack-channel >>
          event: fail
          custom: |
              {
                "blocks": [
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "plain_text",
                        "text": "Error on frontend deployment << pipeline.parameters.deploy-env >> << pipeline.parameters.deploy-version >> << pipeline.parameters.deploy-app-config >>",
                        "emoji": true
                      }
                    ]
                  }
                ]
              }
  backend-deploy:
    docker:
      - image: cimg/node:16.20
    steps:
      - checkout
      - aws-cli/setup
      - run: npm install -g serverless@3.30.1 serverless-prune-plugin@2.0.2
      - run: ./scripts/get-config.sh ./config backend << pipeline.parameters.deploy-env >> << pipeline.parameters.deploy-app-config >>
      - run: ./scripts/decrypt.sh ./config
      - run: ./scripts/backend-deploy.sh << pipeline.parameters.deploy-env >> << pipeline.parameters.deploy-version >> ./config
      - slack/notify:
          channel: << pipeline.parameters.slack-channel >>
          event: pass
          custom: |
              {
                "blocks": [
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "plain_text",
                        "text": "${OUTPUTMSG}",
                        "emoji": true
                      }
                    ],
                    "accessory": {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Release now ðŸš€",
                        "emoji": true
                      },
                      "value": "release backend << pipeline.parameters.deploy-env >> ${DEPLOYED_VERSION}",
                      "action_id": "command"
                    }
                  }
                ]
              }
      - slack/notify:
          channel: << pipeline.parameters.slack-channel >>
          event: fail
          custom: |
              {
                "blocks": [
                  {
                    "type": "section",
                    "fields": [
                      {
                        "type": "plain_text",
                        "text": "Error on backend deployment << pipeline.parameters.deploy-env >> << pipeline.parameters.deploy-version >> << pipeline.parameters.deploy-app-config >>",
                        "emoji": true
                      }
                    ]
                  }
                ]
              }
  forum-deploy:
    docker:
      - image: cimg/node:16.20
    steps:
      - checkout
      - aws-cli/setup
      - run: npm install -g serverless@3.30.1
      - run: ./scripts/forum-deploy.sh

  search-deploy:
    docker:
      - image: cimg/node:16.20
    steps:
      - checkout
      - aws-cli/setup
      - run: npm install -g serverless@3.30.1
      - run: ./scripts/decrypt.sh environments/search
      - run: ./scripts/search-deploy.sh

  opsbot-deploy-prod:
    docker:
      - image: cimg/node:16.20
    steps:
      - checkout
      - run: ./scripts/get-config.sh ./config opsbot prod
      - run: ./scripts/decrypt.sh ./config
      - run: npm install -g serverless@3.30.1
      - aws-cli/setup
      - run: ./scripts/opsbot-deploy.sh prod ./config

workflows:
  version: 2
  default:
    when:
      equal: [ auto, << pipeline.parameters.deploy-app >> ]
    jobs:
      - forum-deploy:
          context: aws-prod
      - search-deploy:
          context: aws-prod
      - opsbot-deploy-prod:
          context: aws-prod
  frontend-deploy-dev:
    when:
      and:
        - equal: [ frontend, << pipeline.parameters.deploy-app >> ]
        - equal: [ dev, << pipeline.parameters.aws-account >> ]
    jobs:
      - frontend-deploy:
          context: [ slack-secrets, aws-dev ]
  frontend-deploy-prod:
    when:
      and:
        - equal: [ frontend, << pipeline.parameters.deploy-app >> ]
        - equal: [ prod, << pipeline.parameters.aws-account >> ]
    jobs:
      - frontend-deploy:
          context: [ slack-secrets, aws-prod ]
  backend-deploy-dev:
    when:
      and:
        - equal: [ backend, << pipeline.parameters.deploy-app >> ]
        - equal: [ dev, << pipeline.parameters.aws-account >> ]
    jobs:
      - backend-deploy:
          context: [ slack-secrets, aws-dev ]
  backend-deploy-prod:
    when:
      and:
        - equal: [ backend, << pipeline.parameters.deploy-app >> ]
        - equal: [ prod, << pipeline.parameters.aws-account >> ]
    jobs:
      - backend-deploy:
          context: [ slack-secrets, aws-prod ]
